<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Portfolio">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#667eea">
  <title>Portfolio Analytics</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      color: black;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }
    
    @media (min-width: 768px) {
      body {
        padding: 20px;
      }
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      background: white;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      position: relative;
    }
    
    @media (min-width: 768px) {
      header {
        padding: 30px;
        margin-bottom: 20px;
      }
    }
    
    h1 {
      color: black;
      font-size: 1.5em;
      margin-bottom: 10px;
      word-break: break-word;
    }
    
    @media (min-width: 768px) {
      h1 {
        font-size: 2.5em;
      }
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    @media (min-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }
    
    @media (min-width: 768px) {
      .stat-card {
        padding: 20px;
      }
    }
    
    .stat-card h3 {
      font-size: 0.75em;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    
    @media (min-width: 768px) {
      .stat-card h3 {
        font-size: 0.9em;
        margin-bottom: 10px;
      }
    }
    
    .stat-card .value {
      font-size: 1.3em;
      font-weight: bold;
    }
    
    @media (min-width: 768px) {
      .stat-card .value {
        font-size: 2em;
      }
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tab-button {
      background: white;
      border: 2px solid #e9ecef;
      padding: 12px 15px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s;
      color: black;
      min-height: 44px;
      min-width: 44px;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }
    
    @media (min-width: 768px) {
      .tab-button {
        padding: 12px 20px;
        font-size: 14px;
      }
    }
    
    .tab-button:hover {
      background: #f8f9fa;
      border-color: #667eea;
    }
    
    .tab-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .panel {
      background: white;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (min-width: 768px) {
      .panel {
        padding: 25px;
        margin-bottom: 20px;
      }
    }
    
    .panel h2 {
      color: black;
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    
    @media (min-width: 768px) {
      .panel h2 {
        margin-bottom: 20px;
        font-size: 1.5em;
      }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.85em;
    }
    
    @media (min-width: 768px) {
      table {
        font-size: 1em;
      }
    }
    
    table th {
      background: #f8f9fa;
      padding: 8px 6px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
      font-size: 0.9em;
    }
    
    @media (min-width: 768px) {
      table th {
        padding: 12px;
        font-size: 1em;
      }
    }
    
    table td {
      padding: 8px 6px;
      border-bottom: 1px solid #e9ecef;
    }
    
    @media (min-width: 768px) {
      table td {
        padding: 12px;
      }
    }
    
    table tr:hover {
      background: #f8f9fa;
    }
    
    .positive { color: #28a745; }
    .negative { color: #dc3545; }
    
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2em;
      color: black;
    }
    
    .error {
      color: black;
      text-align: center;
      padding: 20px;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 5px;
      min-height: 44px;
      min-width: 44px;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-top: 20px;
    }
    
    @media (min-width: 768px) {
      .comparison-grid {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
    }
    
    .comparison-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border: 3px solid transparent;
    }
    
    .comparison-card.selected {
      border-color: #667eea;
      background: #e7f3ff;
    }
    
    .comparison-card h3 {
      font-size: 1.8em;
      margin-bottom: 15px;
    }
    
    .metric {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #dee2e6;
    }
    
    .metric:last-child {
      border-bottom: none;
    }
    
    .metric-label {
      font-weight: 600;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e9ecef;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .stock-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .stock-checkbox {
      padding: 10px 15px;
      border: 2px solid #dee2e6;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      background: white;
      min-height: 44px;
      display: flex;
      align-items: center;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }
    
    .stock-checkbox input {
      margin-right: 5px;
    }
    
    .stock-checkbox.checked {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .time-period-buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .time-btn {
      padding: 10px 16px;
      border: 2px solid #dee2e6;
      border-radius: 5px;
      cursor: pointer;
      background: white;
      font-weight: 600;
      min-height: 44px;
      min-width: 44px;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }
    
    .time-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .dividend-section {
      margin-top: 15px;
      padding: 15px;
      background: #fff3cd;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }
    
    .dividend-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 0.9em;
    }
    
    .chart-container {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      height: 200px;
      position: relative;
    }
    
    .price-line {
      position: relative;
      height: 150px;
      margin: 20px 0;
    }
    
    .price-point {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    
    .upload-section {
      background: white;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    @media (min-width: 768px) {
      .upload-section {
        padding: 20px;
        margin-bottom: 20px;
      }
    }
    
    .upload-section h2 {
      color: #667eea;
      margin-bottom: 15px;
    }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      margin: 10px;
    }
    
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-label {
      display: inline-block;
      padding: 14px 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.3s;
      min-height: 44px;
      min-width: 44px;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
      font-size: 16px;
    }
    
    .file-input-label:hover {
      opacity: 0.9;
    }
    
    .upload-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      font-weight: 600;
    }
    
    .upload-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .upload-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .upload-status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* Prevent iOS zoom on input focus */
    input[type="file"] {
      font-size: 16px;
    }
    
    /* Smooth scrolling for iOS */
    * {
      -webkit-overflow-scrolling: touch;
    }
    
    /* Hide scrollbars on mobile for cleaner look */
    @media (max-width: 768px) {
      ::-webkit-scrollbar {
        width: 0px;
        height: 0px;
      }
    }
    
    .creator-badge {
      font-size: 1.2em;
      color: #667eea;
      font-weight: 700;
      position: absolute;
      top: 20px;
      right: 20px;
      margin: 0;
      font-style: normal;
    }
    
    @media (max-width: 768px) {
      .creator-badge {
        position: static;
        font-size: 0.9em;
        margin-top: 10px;
        text-align: center;
      }
    }
    
    .privacy-disclaimer {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      font-size: 0.9em;
    }
    
    .privacy-disclaimer h3 {
      color: #856404;
      margin-bottom: 10px;
      font-size: 1.1em;
    }
    
    .privacy-disclaimer p {
      color: #856404;
      line-height: 1.6;
      margin: 5px 0;
    }
    
    footer {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    footer p {
      margin: 5px 0;
      color: #6c757d;
      font-size: 0.9em;
    }
    
    footer .designer {
      font-weight: 600;
      color: #667eea;
      font-size: 1em;
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>📊 Portfolio Analytics</h1>
    <p class="creator-badge">Built and Designed by Nathene Stowe</p>
    <p>Private & Secure - Your data never leaves your browser</p>
    
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Equity</h3>
        <div class="value" id="totalValue">$0.00</div>
      </div>
      <div class="stat-card">
        <h3>Total P&L</h3>
        <div class="value" id="totalPnL">$0.00</div>
      </div>
      <div class="stat-card">
        <h3>Total ROI</h3>
        <div class="value" id="totalROI">0.00%</div>
      </div>
      <div class="stat-card">
        <h3>Holdings</h3>
        <div class="value" id="numHoldings">0</div>
      </div>
    </div>
  </header>
  
  <div class="privacy-disclaimer">
    <h3>🔒 Your Privacy is Our Priority</h3>
    <p><strong>100% Private & Secure:</strong> All your portfolio data is processed entirely within your web browser using JavaScript. No information is ever transmitted to any server, stored in any database, or shared with anyone.</p>
    <p><strong>Automatic Data Deletion:</strong> When you close this page or refresh your browser, all uploaded data is immediately and permanently deleted from your device's memory. Nothing is saved.</p>
    <p><strong>Zero Tracking:</strong> We do not collect, store, or analyze any personal information, financial data, or browsing behavior.</p>
  </div>
  
  <div class="upload-section">
    <h2>📂 Upload Your Portfolio CSV</h2>
    <p style="margin-bottom: 15px;">Your CSV file is processed entirely in your browser - no data is sent to any server.</p>
    <div class="file-input-wrapper">
      <input type="file" id="csvFileInput" accept=".csv,text/csv,application/csv,text/comma-separated-values" onchange="handleFileUpload(event)">
      <label for="csvFileInput" class="file-input-label">📁 Choose CSV File</label>
    </div>
    <div id="uploadStatus" class="upload-status info">No file selected. Please upload your portfolio CSV to begin.</div>
  </div>

  <div class="tabs">
    <button class="tab-button active" onclick="switchTab('overview')">📈 Holdings</button>
    <button class="tab-button" onclick="switchTab('sectors')">🥧 Sectors</button>
    <button class="tab-button" onclick="switchTab('performance')">🎯 Performance</button>
    <button class="tab-button" onclick="switchTab('comparison')">⚖️ Compare</button>
  </div>

  <div id="overview" class="tab-content active">
    <div class="panel">
      <h2>Current Holdings</h2>
      <div id="holdingsTable">
        <div class="loading"> Loading portfolio data...</div>
      </div>
    </div>
  </div>

  <div id="sectors" class="tab-content">
    <div class="panel">
      <h2>Sector Allocation</h2>
      <div id="sectorsTable">
        <div class="loading"> Loading sector data...</div>
      </div>
    </div>
  </div>

  <div id="performance" class="tab-content">
    <div class="panel">
      <h2>Best Performers</h2>
       <div id="bestPerformers">
        <div class="loading"> Loading...</div>
      </div>
    </div>
    <div class="panel">
      <h2>Worst Performers</h2>
      <div id="worstPerformers">
        <div class="loading"> Loading...</div>
      </div>
    </div>
  </div>

  <div id="comparison" class="tab-content">
    <div class="panel">
      <h2>Stock Comparison Analysis</h2>
      <p style="margin-bottom: 15px;">Select stocks to compare performance:</p>
      <div id="stockSelector" class="stock-selector"></div>
      
      <div style="margin: 20px 0;">
        <strong>Time Period:</strong>
        <div class="time-period-buttons">
          <button class="time-btn" onclick="setTimePeriod('1M')">1 Month</button>
          <button class="time-btn" onclick="setTimePeriod('3M')">3 Months</button>
          <button class="time-btn" onclick="setTimePeriod('6M')">6 Months</button>
          <button class="time-btn active" onclick="setTimePeriod('1Y')">1 Year</button>
          <button class="time-btn" onclick="setTimePeriod('ALL')">All Time</button>
        </div>
      </div>
      
      <button onclick="compareSelected()">Compare Selected</button>
      <button onclick="clearComparison()" style="background: #6c757d;">Clear</button>
      <div id="comparisonResults" class="comparison-grid"></div>
    </div>
  </div>

</div>

<footer>
  <p class="designer">Web Designer: Nathene Stowe</p>
  <p>© 2026 Portfolio Analytics | Privacy-Focused Financial Tools</p>
</footer>

<script>
  const API_BASE = 'http://localhost:8000';
  let portfolioData = null;
  let selectedStocks = new Set();
  let timePeriod = '1Y';
  let csvData = [];
  let dividendData = {};
  let uploadedCSVContent = null;
  
  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const statusEl = document.getElementById('uploadStatus');
    statusEl.textContent = 'Processing CSV file...';
    statusEl.className = 'upload-status info';
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        uploadedCSVContent = e.target.result;
        parseUploadedCSV(uploadedCSVContent);
        statusEl.textContent = `✅ Success! Loaded ${csvData.length} transactions. Data processed locally in your browser.`;
        statusEl.className = 'upload-status success';
        
        // Auto-load overview
        loadOverview();
      } catch (error) {
        console.error('Error parsing CSV:', error);
        statusEl.textContent = `❌ Error: ${error.message}. Please check your CSV format.`;
        statusEl.className = 'upload-status error';
      }
    };
    reader.onerror = function() {
      statusEl.textContent = '❌ Error reading file. Please try again.';
      statusEl.className = 'upload-status error';
    };
    reader.readAsText(file);
  }
  
  function parseUploadedCSV(text) {
    csvData = [];
    dividendData = {};
    
    const lines = text.split('\n');
    if (lines.length < 2) throw new Error('CSV file is empty or invalid');
    
    const headers = lines[0].split(',').map(h => h.trim());
    
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      
      // Handle quoted fields properly
      const values = [];
      let current = '';
      let inQuotes = false;
      
      for (let j = 0; j < lines[i].length; j++) {
        const char = lines[i][j];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      values.push(current.trim());
      
      if (values.length < 7) continue;
      
      const row = {
        date: values[0].replace(/"/g, ''),
        symbol: values[1].replace(/"/g, ''),
        description: values[2].replace(/"/g, ''),
        transCode: values[3].replace(/"/g, ''),
        quantity: values[4].replace(/"/g, ''),
        price: values[5].replace(/"/g, ''),
        amount: values[6].replace(/"/g, '')
      };
      csvData.push(row);
      
      // Extract dividends
      if (row.description && row.description.toLowerCase().includes('dividend')) {
        const symbol = row.symbol.trim();
        if (!dividendData[symbol]) {
          dividendData[symbol] = [];
        }
        
        const amountStr = row.amount.replace(/[$(),]/g, '').trim();
        const amount = Math.abs(parseFloat(amountStr) || 0);
        
        if (amount > 0) {
          dividendData[symbol].push({
            date: row.date,
            amount: amount
          });
        }
      }
    }
    
    if (csvData.length === 0) {
      throw new Error('No valid transactions found in CSV');
    }
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    if (tabName === 'sectors') loadSectors();
    else if (tabName === 'performance') loadPerformance();
    else if (tabName === 'comparison') loadComparison();
  }

  async function loadOverview() {
    if (!uploadedCSVContent) {
      document.getElementById('holdingsTable').innerHTML = '<div class="error">Please upload your portfolio CSV file first.</div>';
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE}/analytics/overview`);
      const data = await response.json();
      
      if (data.error) {
        document.getElementById('holdingsTable').innerHTML = `<div class="error">${data.error}</div>`;
        return;
      }
      
      document.getElementById('totalValue').textContent = '$' + data.total_equity.toLocaleString();
      document.getElementById('totalPnL').textContent = (data.total_pnl >= 0 ? '+' : '') + '$' + data.total_pnl.toLocaleString();
      document.getElementById('totalPnL').className = 'value ' + (data.total_pnl >= 0 ? 'positive' : 'negative');
      document.getElementById('totalROI').textContent = (data.total_roi >= 0 ? '+' : '') + data.total_roi.toFixed(2) + '%';
      document.getElementById('totalROI').className = 'value ' + (data.total_roi >= 0 ? 'positive' : 'negative');
      document.getElementById('numHoldings').textContent = data.holdings.length;
      
      portfolioData = data;
      
      let html = '<table><thead><tr>';
      html += '<th>Symbol</th><th>Shares</th><th>Avg Cost</th><th>Current Price</th><th>Equity</th><th>P&L</th><th>ROI</th><th>Allocation</th><th>Sector</th>';
      html += '</tr></thead><tbody>';
      
      data.holdings.forEach(h => {
        const pnlClass = h.pnl >= 0 ? 'positive' : 'negative';
        const roiClass = h.roi >= 0 ? 'positive' : 'negative';
        html += `<tr>
          <td><strong>${h.symbol}</strong></td>
          <td>${h.shares.toFixed(2)}</td>
          <td>$${h.avg_cost.toFixed(2)}</td>
          <td>$${h.current_price.toFixed(2)}</td>
          <td><strong>$${h.equity.toFixed(2)}</strong></td>
          <td class="${pnlClass}">${h.pnl >= 0 ? '+' : ''}$${h.pnl.toFixed(2)}</td>
          <td class="${roiClass}">${h.roi >= 0 ? '+' : ''}${h.roi.toFixed(2)}%</td>
          <td>${h.allocation.toFixed(2)}%</td>
          <td>${h.sector}</td>
        </tr>`;
      });
      
      html += '</tbody></table>';
      document.getElementById('holdingsTable').innerHTML = html;
      
    } catch (error) {
      console.error('Error loading overview:', error);
      document.getElementById('holdingsTable').innerHTML = '<div class="error">Error loading data</div>';
    }
  }

  async function loadSectors() {
    if (!uploadedCSVContent) {
      document.getElementById('sectorsTable').innerHTML = '<div class="error">Please upload your portfolio CSV file first.</div>';
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE}/analytics/sectors`);
      const data = await response.json();
      
      let html = '<table><thead><tr><th>Sector</th><th>Value</th><th>Percentage</th></tr></thead><tbody>';
      
      data.sectors.forEach(s => {
        html += `<tr>
          <td><strong>${s.sector}</strong></td>
          <td>$${s.value.toFixed(2)}</td>
          <td>${s.percentage.toFixed(2)}%</td>
        </tr>`;
      });
      
      html += '</tbody></table>';
      document.getElementById('sectorsTable').innerHTML = html;
      
    } catch (error) {
      console.error('Error loading sectors:', error);
      document.getElementById('sectorsTable').innerHTML = '<div class="error">Error loading data</div>';
    }
  }

  async function loadPerformance() {
    if (!uploadedCSVContent) {
      document.getElementById('bestPerformers').innerHTML = '<div class="error">Please upload your portfolio CSV file first.</div>';
      document.getElementById('worstPerformers').innerHTML = '<div class="error">Please upload your portfolio CSV file first.</div>';
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE}/analytics/best_worst`);
      const data = await response.json();
      
      let bestHtml = '<table><thead><tr><th>Symbol</th><th>Current Price</th><th>Avg Cost</th><th>ROI</th><th>P&L</th></tr></thead><tbody>';
      data.best.forEach(p => {
        bestHtml += `<tr>
          <td><strong>${p.symbol}</strong></td>
          <td>$${p.current_price.toFixed(2)}</td>
          <td>$${p.avg_cost.toFixed(2)}</td>
          <td class="positive">+${p.roi.toFixed(2)}%</td>
          <td class="positive">+$${p.pnl.toFixed(2)}</td>
        </tr>`;
      });
      bestHtml += '</tbody></table>';
      document.getElementById('bestPerformers').innerHTML = bestHtml;
      
      let worstHtml = '<table><thead><tr><th>Symbol</th><th>Current Price</th><th>Avg Cost</th><th>ROI</th><th>P&L</th></tr></thead><tbody>';
      data.worst.forEach(p => {
        worstHtml += `<tr>
          <td><strong>${p.symbol}</strong></td>
          <td>$${p.current_price.toFixed(2)}</td>
          <td>$${p.avg_cost.toFixed(2)}</td>
          <td class="negative">${p.roi.toFixed(2)}%</td>
          <td class="negative">$${p.pnl.toFixed(2)}</td>
        </tr>`;
      });
      worstHtml += '</tbody></table>';
      document.getElementById('worstPerformers').innerHTML = worstHtml;
      
    } catch (error) {
      console.error('Error loading performance:', error);
      document.getElementById('bestPerformers').innerHTML = '<div class="error">Error loading data</div>';
      document.getElementById('worstPerformers').innerHTML = '<div class="error">Error loading data</div>';
    }
  }

  async function loadCSVData() {
    // CSV data is already loaded from file upload
    if (csvData.length === 0 && !uploadedCSVContent) {
      // Fallback: try to load from server if no upload yet
      try {
        const response = await fetch('portfolio_data.csv');
        if (response.ok) {
          const text = await response.text();
          uploadedCSVContent = text;
          parseUploadedCSV(text);
        }
      } catch (error) {
        console.log('No server CSV available, waiting for user upload');
      }
    }
  }
  
  async function loadComparison() {
    if (!uploadedCSVContent) {
      document.getElementById('stockSelector').innerHTML = '<div class="error">Please upload your portfolio CSV file first.</div>';
      return;
    }
    
    await loadCSVData();
    
    if (!portfolioData) {
      const response = await fetch(`${API_BASE}/analytics/overview`);
      portfolioData = await response.json();
    }
    
    const selector = document.getElementById('stockSelector');
    selector.innerHTML = '';
    
    portfolioData.holdings.forEach(h => {
      const label = document.createElement('label');
      label.className = 'stock-checkbox';
      if (selectedStocks.has(h.symbol)) label.classList.add('checked');
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = h.symbol;
      checkbox.checked = selectedStocks.has(h.symbol);
      checkbox.onchange = (e) => toggleStock(e.target.value, e.target.checked, label);
      
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(h.symbol));
      selector.appendChild(label);
    });
  }
  
  function toggleStock(symbol, checked, label) {
    if (checked) {
      selectedStocks.add(symbol);
      label.classList.add('checked');
    } else {
      selectedStocks.delete(symbol);
      label.classList.remove('checked');
    }
  }
  
  function setTimePeriod(period) {
    timePeriod = period;
    document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    if (selectedStocks.size > 0) {
      compareSelected();
    }
  }
  
  function getTransactionsInPeriod(symbol) {
    if (csvData.length === 0) return [];
    
    const now = new Date();
    let cutoffDate = new Date();
    
    switch(timePeriod) {
      case '1M': cutoffDate.setMonth(now.getMonth() - 1); break;
      case '3M': cutoffDate.setMonth(now.getMonth() - 3); break;
      case '6M': cutoffDate.setMonth(now.getMonth() - 6); break;
      case '1Y': cutoffDate.setFullYear(now.getFullYear() - 1); break;
      case 'ALL': cutoffDate = new Date(0); break;
    }
    
    return csvData.filter(row => {
      if (row.symbol.replace(/"/g, '').trim() !== symbol) return false;
      const rowDate = new Date(row.date);
      return rowDate >= cutoffDate;
    });
  }
  
  function compareSelected() {
    if (selectedStocks.size === 0) {
      alert('Please select at least one stock to compare');
      return;
    }
    
    const results = document.getElementById('comparisonResults');
    results.innerHTML = '';
    
    const selected = portfolioData.holdings.filter(h => selectedStocks.has(h.symbol));
    selected.sort((a, b) => b.roi - a.roi);
    
    selected.forEach(stock => {
      const card = document.createElement('div');
      card.className = 'comparison-card selected';
      
      // Calculate dividends for this stock
      const stockDividends = dividendData[stock.symbol] || [];
      const totalDividends = stockDividends.reduce((sum, d) => sum + d.amount, 0);
      
      // Adjust P&L to include dividends
      const adjustedPnL = stock.pnl + totalDividends;
      const adjustedROI = stock.avg_cost > 0 ? ((adjustedPnL / (stock.shares * stock.avg_cost)) * 100) : 0;
      
      const roiClass = adjustedROI >= 0 ? 'positive' : 'negative';
      const pnlClass = adjustedPnL >= 0 ? 'positive' : 'negative';
      
      // Get transactions in time period
      const periodTransactions = getTransactionsInPeriod(stock.symbol);
      
      card.innerHTML = `
        <h3>${stock.symbol}</h3>
        <div style="font-size: 0.85em; color: #6c757d; margin-bottom: 10px;">
          Period: ${timePeriod} | ${periodTransactions.length} transactions
        </div>
        <div class="metric">
          <span class="metric-label">Current Price:</span>
          <span><strong>$${stock.current_price.toFixed(2)}</strong></span>
        </div>
        <div class="metric">
          <span class="metric-label">Avg Cost:</span>
          <span>$${stock.avg_cost.toFixed(2)}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Shares:</span>
          <span>${stock.shares.toFixed(2)}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Total Equity:</span>
          <span><strong>$${stock.equity.toFixed(2)}</strong></span>
        </div>
        <div class="metric">
          <span class="metric-label">P&L (Trading):</span>
          <span class="${stock.pnl >= 0 ? 'positive' : 'negative'}">${stock.pnl >= 0 ? '+' : ''}$${stock.pnl.toFixed(2)}</span>
        </div>
        ${totalDividends > 0 ? `
        <div class="metric">
          <span class="metric-label">Dividends Received:</span>
          <span class="positive">+$${totalDividends.toFixed(2)}</span>
        </div>
        <div class="metric" style="border-top: 2px solid #667eea; padding-top: 8px; margin-top: 8px;">
          <span class="metric-label"><strong>Total Gain (w/ Dividends):</strong></span>
          <span class="${pnlClass}"><strong>${adjustedPnL >= 0 ? '+' : ''}$${adjustedPnL.toFixed(2)}</strong></span>
        </div>
        <div class="metric">
          <span class="metric-label"><strong>Total ROI (w/ Dividends):</strong></span>
          <span class="${roiClass}"><strong>${adjustedROI >= 0 ? '+' : ''}${adjustedROI.toFixed(2)}%</strong></span>
        </div>
        ` : `
        <div class="metric">
          <span class="metric-label">Total P&L:</span>
          <span class="${pnlClass}"><strong>${stock.pnl >= 0 ? '+' : ''}$${stock.pnl.toFixed(2)}</strong></span>
        </div>
        <div class="metric">
          <span class="metric-label">ROI:</span>
          <span class="${roiClass}"><strong>${stock.roi >= 0 ? '+' : ''}${stock.roi.toFixed(2)}%</strong></span>
        </div>
        `}
        <div class="metric">
          <span class="metric-label">Allocation:</span>
          <span>${stock.allocation.toFixed(2)}%</span>
        </div>
        <div class="metric">
          <span class="metric-label">Sector:</span>
          <span>${stock.sector}</span>
        </div>
        ${stockDividends.length > 0 ? `
        <div class="dividend-section">
          <strong>💰 Dividend History (${stockDividends.length} payments)</strong>
          ${stockDividends.slice(0, 5).map(d => `
            <div class="dividend-row">
              <span>${d.date}</span>
              <span>+$${d.amount.toFixed(2)}</span>
            </div>
          `).join('')}
          ${stockDividends.length > 5 ? '<div style="text-align: center; font-size: 0.8em; margin-top: 5px;">... and ' + (stockDividends.length - 5) + ' more</div>' : ''}
        </div>
        ` : ''}
        <div style="margin-top: 15px;">
          <strong>${totalDividends > 0 ? 'Total ROI' : 'ROI'} Performance:</strong>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${Math.min(Math.abs(totalDividends > 0 ? adjustedROI : stock.roi), 100)}%; background: ${(totalDividends > 0 ? adjustedROI : stock.roi) >= 0 ? '#28a745' : '#dc3545'};">
              ${(totalDividends > 0 ? adjustedROI : stock.roi).toFixed(1)}%
            </div>
          </div>
        </div>
      `;
      
      results.appendChild(card);
    });
  }
  
  function clearComparison() {
    selectedStocks.clear();
    document.getElementById('comparisonResults').innerHTML = '';
    document.querySelectorAll('.stock-checkbox').forEach(el => {
      el.classList.remove('checked');
      el.querySelector('input').checked = false;
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Don't auto-load, wait for CSV upload
    document.getElementById('holdingsTable').innerHTML = '<div class="loading">📂 Please upload your portfolio CSV file to view your holdings.</div>';
  });
  
  // Clear data on page unload for privacy
  window.addEventListener('beforeunload', () => {
    csvData = [];
    dividendData = {};
    uploadedCSVContent = null;
    portfolioData = null;
  });
</script>

</body>
</html>
